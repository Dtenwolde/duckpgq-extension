# name: test/sql/create_pg/create_pg_with_pk_fk.test
# description: Testing create with predefined primary and foreign keys
# group: [duckpgq_sql_create_pg]

require duckpgq

statement ok
create table v (
    id BIGINT primary key,
    name varchar
);

statement ok
INSERT INTO v VALUES (1, 'a');

statement ok
create table e (
    id bigint primary key,
    src BIGINT references v(id),
    dst BIGINT references v(id)
);

statement error
-create property graph g
vertex tables (v)
edge tables (e source v destination v);
----
Invalid Error: Multiple primary key - foreign key relationships detected with the same table. Please explicitly define the primary key and foreign key columns using `SOURCE KEY <primary key> references v <foreign key>`

statement ok
create table w (
    id BIGINT primary key,
    name varchar
);

statement ok
INSERT INTO w VALUES (2, 'b');

statement ok
create table e2 (
    id bigint primary key,
    src BIGINT references v(id),
    dst BIGINT references w(id)
);

statement ok
INSERT INTO e2 VALUES (1, 1, 2);

statement error
-create property graph g
vertex tables (v)
edge tables (e2 source v destination w);
----
Invalid Error: Referenced vertex table w is not registered in the vertex tables

statement ok
-create property graph g
vertex tables (v, w)
edge tables (e2 source v destination w);

query II
-FROM GRAPH_TABLE (g MATCH (v:v)-[e2:e2]->(w:w) COLUMNS (v.id, w.id));
----
1	2

statement ok
CREATE TABLE a (
    id BIGINT,
    name VARCHAR
);

statement error
CREATE TABLE b (
    name VARCHAR,
    src BIGINT REFERENCES a(id),
    dst BIGINT,
);
----
Binder Error: Failed to create foreign key: there is no primary key or unique constraint for referenced table "a"

statement ok
CREATE TABLE b (
    name VARCHAR,
    src BIGINT,
    dst BIGINT,
);

statement error
-CREATE PROPERTY GRAPH g2 VERTEX TABLES (a) EDGE TABLES (b SOURCE a DESTINATION a);
----
Invalid Error: No primary key - foreign key relationship found in b with source table a

statement ok
CREATE TABLE a_pk (
    id BIGINT primary key,
    name VARCHAR
);

statement ok
CREATE TABLE b_pk (
    name VARCHAR,
    src BIGINT REFERENCES a_pk(id),
    dst BIGINT,
);

statement ok
-CREATE PROPERTY GRAPH g2 VERTEX TABLES (a_pk) EDGE TABLES (b_pk SOURCE a_pk DESTINATION a_pk);

statement ok
CREATE TABLE x (
    id BIGINT PRIMARY KEY,
    name VARCHAR
);

statement ok
CREATE TABLE y (
    id BIGINT PRIMARY KEY,
    src BIGINT REFERENCES x(id),
    dst BIGINT REFERENCES x(id)
);

statement error
-CREATE PROPERTY GRAPH g3
VERTEX TABLES (x)
EDGE TABLES (y SOURCE x DESTINATION x);
----
Invalid Error: Multiple primary key - foreign key relationships detected with the same table. Please explicitly define the primary key and foreign key columns using `SOURCE KEY <primary key> references x <foreign key>`

statement ok
-CREATE PROPERTY GRAPH g3_explicit
VERTEX TABLES (x)
EDGE TABLES (y SOURCE KEY (src) REFERENCES x (id)
                             DESTINATION KEY (dst) REFERENCES x (id));

query I
-FROM GRAPH_TABLE (g3_explicit MATCH (x:x)-[y:y]->(x:x) COLUMNS (x.id));
----

statement ok
CREATE TABLE m (
    id BIGINT PRIMARY KEY,
    name VARCHAR
);

statement ok
CREATE TABLE n (
    id BIGINT PRIMARY KEY,
    src BIGINT,
    dst BIGINT
);

statement error
-CREATE PROPERTY GRAPH g4
VERTEX TABLES (m)
EDGE TABLES (n SOURCE m DESTINATION m);
----
Invalid Error: The primary key for the source table m is not defined in the edge table n



