# name: test/sql/path_finding/parallel_path_finding.test
# description: Prototype the path finding operator
# group: [duckpgq_sql_path_finding]

#statement ok
#PRAGMA enable_verification

require duckpgq

statement ok
set experimental_path_finding_operator=true;

query I
SELECT current_setting('experimental_path_finding_operator');
----
true

statement ok
CREATE TABLE pair(src BIGINT, dst BIGINT); INSERT INTO pair(src, dst) VALUES (0, 1), (1, 2), (2,0);

statement ok
create table student(id INT); INSERT INTO student(id) VALUES (10), (20), (30), (40);

statement ok
create table know(src INT, dst INT); INSERT INTO know(src, dst) VALUES (40, 20), (10,30), (10,10), (20,10), (30,10);

query III
WITH shortestpath_cte as (
SELECT src, dst, shortestpathoperator(src, dst, 'pair') as path
FROM pair p
WHERE p.src between (SELECT CSR_OPERATOR(
                             (SELECT count(a.id) as v_size FROM Student a),
                             (SELECT count(k.src) as e_size from know k),
                               a.rowid,
                               c.rowid,
                               k.rowid,
                               t.cnt) FROM Know k
                                           JOIN student a on a.id = k.src
                                           JOIN student c on c.id = k.dst
                                           JOIN (SELECT count(k.src) cnt, a.rowid as a_rowid
                                                   FROM student a
                                                  LEFT JOIN know k ON k.src = a.id
                                                  GROUP BY a.rowid) t
                                              ON t.a_rowid = a.rowid) and p.dst)
 SELECT * FROM shortestpath_cte;
----
0	1	NULL
1	2	[1, 3, 0, 1, 2]
2	0	[2, 4, 0]

# MATCH ANY SHORTEST p = (a:Person)-[k2:knows]->(src:Person WHERE src.id = 10)-[k:knows]->*(dst:Person)
# COLUMNS (element_id(p)) AS path
query IIII
WITH pairs as (
    SELECT src, dst
    FROM (SELECT a.rowid AS src FROM Student a where id = 10),
        (SELECT b.rowid AS dst FROM Student b)
), p_cte as (
SELECT src, dst, shortestpathoperator(src, dst, 'pairs') as path
FROM pairs p
WHERE p.src between (SELECT CSR_OPERATOR(
                             (SELECT count(a.id) as v_size FROM Student a),
                             (SELECT count(k.src) as e_size from know k),
                               a.rowid,
                               c.rowid,
                               k.rowid,
                               t.cnt) FROM Know k
                                           JOIN student a on a.id = k.src
                                           JOIN student c on c.id = k.dst
                                           JOIN (SELECT count(k.src) cnt, a.rowid as a_rowid
                                                   FROM student a
                                                  LEFT JOIN know k ON k.src = a.id
                                                  GROUP BY a.rowid) t
                                              ON t.a_rowid = a.rowid) and p.dst)
SELECT a.id, src.id, p_cte.src, p_cte.dst, src.id as src_id, path FROM p_cte
JOIN student src on p_cte.src = rowid
JOIN know k2 on k2.dst = src.id
JOIN student a on a.id = k2.src
ORDER BY p_cte.dst;
----
0	0	10	[0]
0	1	10	NULL
0	2	10	[0, 1, 2]
0	3	10	NULL

query IIII
WITH pairs as (
    SELECT src, dst
    FROM (SELECT a.rowid AS src FROM Student a where id = 10),
        (SELECT b.rowid AS dst FROM Student b)
), shortestpath_cte as (
SELECT src, dst, shortestpathoperator(src, dst, 'pairs') as path
FROM pairs p
WHERE p.src between (SELECT CSR_OPERATOR(
                             (SELECT count(a.id) as v_size FROM Student a),
                             (SELECT count(k.src) as e_size from know k),
                               a.rowid,
                               c.rowid,
                               k.rowid,
                               t.cnt) FROM Know k
                                           JOIN student a on a.id = k.src
                                           JOIN student c on c.id = k.dst
                                           JOIN (SELECT count(k.src) cnt, a.rowid as a_rowid
                                                   FROM student a
                                                  LEFT JOIN know k ON k.src = a.id
                                                  GROUP BY a.rowid) t
                                              ON t.a_rowid = a.rowid) and p.dst)
SELECT src, dst, src.id as src_id, path FROM shortestpath_cte
JOIN student src on src = rowid
ORDER BY dst;
----
0	0	10	[0]
0	1	10	NULL
0	2	10	[0, 1, 2]
0	3	10	NULL


query III
SELECT *, shortestpathoperator(src, dst, 'pair') as path
FROM pair AS p
WHERE p.src BETWEEN (SELECT CSR_OPERATOR(
            (SELECT count(a.id) as v_size FROM Student a),
            (SELECT count(k.src) as e_size from know k),
              a.rowid,
              c.rowid,
              k.rowid,
              t.cnt)    FROM Know k
                          JOIN student a on a.id = k.src
                          JOIN student c on c.id = k.dst
                          JOIN (SELECT count(k.src) cnt, a.rowid as a_rowid
                                  FROM student a
                                 LEFT JOIN know k ON k.src = a.id
                                 GROUP BY a.rowid) t
                             ON t.a_rowid = a.rowid) AND p.dst;
----
0	1	NULL
1	2	[1, 3, 0, 1, 2]
2	0	[2, 4, 0]




statement ok
import database 'duckdb-pgq/data/SNB0.003';

statement ok
select setseed(0.42)

statement ok
CREATE OR REPLACE TABLE pairs2 AS (
    SELECT src, dst
    FROM (SELECT a.rowid AS src FROM Person a),
        (SELECT b.rowid AS dst FROM Person b)
    USING SAMPLE reservoir(2 ROWS) REPEATABLE (300)
);

query III
SELECT *, shortestpathoperator(src, dst, 'pairs2') as length
FROM pairs2 AS p
WHERE p.src BETWEEN (SELECT CSR_OPERATOR(
            (SELECT count(a.id) as v_size FROM Person a),
            (SELECT count(k.Person1Id) as e_size FROM Person_knows_Person k),
            a.rowid,
            c.rowid,
            k.rowid,
            t.cnt)    FROM Person_knows_Person k
                        JOIN Person a on a.id = k.Person1Id
                        JOIN Person c on c.id = k.Person2Id
                        JOIN (SELECT count(k.Person1Id) cnt, a.rowid as a_rowid
                                FROM Person a
                                LEFT JOIN Person_knows_Person k ON k.Person1Id = a.id
                                GROUP BY a.rowid) t
                            ON t.a_rowid = a.rowid) AND p.dst;
----
42	22	NULL
3	33	[3, 13, 26, 64, 33]

query III
SELECT *, iterativelengthoperator(src, dst, 'pairs2') as length
FROM pairs2 AS p
WHERE p.src BETWEEN (SELECT CSR_OPERATOR(
            (SELECT count(a.id) as v_size FROM Person a),
            (SELECT count(k.Person1Id) as e_size FROM Person_knows_Person k),
            a.rowid,
            c.rowid,
            k.rowid,
            t.cnt)    FROM Person_knows_Person k
                        JOIN Person a on a.id = k.Person1Id
                        JOIN Person c on c.id = k.Person2Id
                        JOIN (SELECT count(k.Person1Id) cnt, a.rowid as a_rowid
                                FROM Person a
                                LEFT JOIN Person_knows_Person k ON k.Person1Id = a.id
                                GROUP BY a.rowid) t
                            ON t.a_rowid = a.rowid) AND p.dst;
----
42	22	NULL
3	33	2

statement ok
CREATE OR REPLACE TABLE pairs3 AS (
    SELECT src, dst
    FROM (SELECT a.rowid AS src FROM Person a),
        (SELECT b.rowid AS dst FROM Person b)
    USING SAMPLE reservoir(1 ROWS) REPEATABLE (300)
);

query II
from pairs3;
----
10	2

query III
SELECT *, iterativelengthoperator(src, dst, 'pairs3') as length
FROM pairs3 as p
WHERE p.src BETWEEN (SELECT CSR_OPERATOR(
            (SELECT count(a.id) as v_size FROM Person a),
            (SELECT count(k.Person1Id) as e_size FROM Person_knows_Person k),
            a.rowid,
            c.rowid,
            k.rowid,
            t.cnt)    FROM Person_knows_Person k
                        JOIN Person a on a.id = k.Person1Id
                        JOIN Person c on c.id = k.Person2Id
                        JOIN (SELECT count(k.Person1Id) cnt, a.rowid as a_rowid
                                FROM Person a
                                LEFT JOIN Person_knows_Person k ON k.Person1Id = a.id
                                GROUP BY a.rowid) t
                            ON t.a_rowid = a.rowid) AND p.dst;
----
10	2	NULL

statement ok
CREATE OR REPLACE TABLE Student(id BIGINT, name VARCHAR); INSERT INTO Student VALUES (0, 'Daniel'), (1, 'Tavneet'), (2, 'Gabor'), (3, 'Peter'), (4, 'David');

statement ok
CREATE OR REPLACE TABLE know(src BIGINT, dst BIGINT, createDate BIGINT); INSERT INTO know VALUES (0,1, 10), (0,2, 11), (0,3, 12), (3,0, 13), (1,2, 14), (1,3, 15), (2,3, 16), (4,3, 17);

query III
WITH pairs as (
    SELECT src, dst
    FROM (SELECT a.rowid AS src FROM Student a),
        (SELECT b.rowid AS dst FROM Student b)
)
SELECT src, dst, shortestpathoperator(src, dst, 'pairs') as path
FROM pairs p
WHERE p.src BETWEEN (SELECT CSR_OPERATOR(
            (SELECT count(a.id) as v_size FROM Student a),
            (SELECT count(k.src) as e_size from know k),
              a.rowid,
              c.rowid,
              k.rowid,
              t.cnt)    FROM Know k
                          JOIN student a on a.id = k.src
                          JOIN student c on c.id = k.dst
                          JOIN (SELECT count(k.src) cnt, a.rowid as a_rowid
                                  FROM student a
                                 LEFT JOIN know k ON k.src = a.id
                                 GROUP BY a.rowid) t
                             ON t.a_rowid = a.rowid) AND p.dst;
----
0	0	[0]
0	1	[0, 0, 1]
0	2	[0, 1, 2]
0	3	[0, 2, 3]
0	4	NULL
1	1	[1]
1	2	[1, 4, 2]
1	3	[1, 5, 3]
1	4	NULL
2	2	[2]
2	3	[2, 6, 3]
2	4	NULL
3	3	[3]
3	4	NULL
4	4	[4]